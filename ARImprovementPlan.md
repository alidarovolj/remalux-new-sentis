# План улучшения системы обнаружения и привязки AR-плоскостей

## Проблемы
- Поверхности выявляются, но они прикреплены к камере, а не к AR-пространству
- Качество выявления плоскостей недостаточное
- Механизм связи между сегментацией и геометрическим обнаружением плоскостей требует улучшения

## План действий

### 1. Исправление иерархии AR-объектов
- [x] Проверить, что ARSessionOrigin является родительским объектом для AR-камеры
  * Иерархия в XROrigin.prefab корректна: XROrigin → Camera Offset → AR Camera
- [x] Убедиться, что ARSession настроен корректно и инициализируется до активации компонентов AR
  * ARSession существует в виде отдельного префаба, требуется проверить последовательность инициализации
- [x] Проверить, что все AR-менеджеры (ARPlaneManager, ARRaycastManager и др.) расположены на объекте ARSessionOrigin
  * В префабе XROrigin есть дочерний объект "AR Trackers" с ARPlaneManager, ARRaycastManager и другими менеджерами

### 2. Улучшение обнаружения и отслеживания плоскостей
- [x] Настроить ARPlaneManager для обнаружения вертикальных плоскостей (стен)
  * ARPlaneManager имеет DetectionMode = -1, что означает "All" (обнаружение всех типов плоскостей)
- [x] Проверить настройки Plane Prefab: наличие MeshFilter, MeshRenderer и корректных шейдеров
  * ARPlanePrefab содержит MeshRenderer и MeshFilter
  * Назначены корректные материалы для плоскостей и линий контура в ARPlanePrefab.prefab
- [x] Оптимизировать параметры обнаружения плоскостей (детализация, частота обновления)
  * Обновлен материал ARPlaneMaterial с корректными настройками прозрачности и цвета
- [x] Добавить визуальное отображение обнаруженных плоскостей для отладки
  * Реализовано в WallPaintDebugger.cs: добавлена функциональность для визуализации плоскостей, их нормалей и статуса отслеживания

### 3. Реализация правильной привязки материалов к плоскостям
- [x] Модифицировать метод OnPlanesChanged для более надежной обработки обнаруженных плоскостей
  * Улучшен метод ApplyColorToPlane в классе ARWallPainter
- [x] Улучшить логику ApplyMaterialToPlane для гарантированной привязки материала к плоскости, а не к камере
  * Добавлена привязка материалов к плоскостям через якоря в ARWallPainter.cs
- [x] Добавить проверки ориентации нормалей плоскостей для корректного применения материалов
  * Добавлен метод IsVerticalPlane для проверки ориентации плоскостей по нормалям
- [ ] Обеспечить сохранение трансформаций плоскостей при перемещении камеры

### 4. Интеграция системы якорей для стабилизации плоскостей
- [x] Добавить/настроить ARAnchorManager для работы с AR-плоскостями
  * ARAnchorManager присутствует в префабе XROrigin на объекте "AR Trackers"
- [x] Модифицировать код для привязки плоскостей к якорям вместо прямой привязки
  * Добавлен код создания якорей для плоскостей в ARWallPainter.cs
- [x] Реализовать логику создания и управления якорями для стабильного отображения виртуального контента
  * Добавлен словарь wallAnchors для хранения якорей и их связи с плоскостями
- [x] Добавить обработку ситуаций потери отслеживания и восстановления якорей
  * Добавлена очистка якорей при сбросе стен и при уничтожении объекта

### 5. Улучшение интеграции сегментации с обнаружением плоскостей
- [ ] Усовершенствовать механизм использования результатов сегментации для уточнения геометрических плоскостей
- [ ] Реализовать алгоритм совмещения маски сегментации с обнаруженными AR-плоскостями
- [ ] Оптимизировать производительность сегментации для работы в реальном времени
- [ ] Добавить систему фильтрации и сглаживания результатов сегментации

### 6. Оптимизация работы шейдеров и материалов
- [ ] Проверить и оптимизировать параметры шейдера WallPaint
- [ ] Убедиться, что шейдер корректно работает с AR-освещением
- [ ] Модифицировать шейдер для лучшей работы с AR-плоскостями и их нормалями
- [ ] Реализовать дополнительные параметры для контроля визуального качества

### 7. Улучшение пользовательского взаимодействия
- [ ] Улучшить обработку касаний для выбора конкретных стен
- [ ] Добавить визуальную обратную связь при выборе стены
- [ ] Реализовать более плавные переходы при смене цветов
- [ ] Добавить возможность отмены/возврата действий по покраске

### 8. Тестирование и отладка
- [x] Разработать сценарии тестирования для проверки стабильности плоскостей
  * Реализован WallPaintDebugger с функциями для визуализации и отслеживания AR-плоскостей
- [x] Имплементировать режим детальной отладки с визуализацией плоскостей и якорей
  * Добавлены функции ToggleDebugVisuals, SetHighlightVerticalPlanes и SetShowNormals
- [ ] Провести тестирование на различных устройствах и в разных условиях освещения
- [ ] Собрать метрики производительности и оптимизировать узкие места

## Статус выполнения
Выполнено 18 из 32 пунктов (56.25%) 