# План Улучшения Проекта Виртуальной Покраски Стен

## Цель:
- [ ] Достичь качества визуализации и функциональности, сопоставимых с передовыми приложениями для виртуальной примерки цвета стен (например, Dulux Visualizer).

## Ключевые Направления Работы:

### 1. Улучшение Системы Сегментации Стен
   - [ ] **1.1. Повышение точности и стабильности текущей ML-модели:**
       - [ ] Анализ текущих ошибок сегментации (пропуски, ложные срабатывания).
       - [ ] Эксперименты с параметрами модели (пороги уверенности).
       - [ ] Сбор и разметка дополнительных данных для дообучения модели, если это возможно и целесообразно.
       - [ ] Рассмотрение возможности использования техник аугментации данных.
   - [ ] **1.2. Исследование и интеграция альтернативных ML-моделей:**
       - [ ] Поиск state-of-the-art моделей для семантической сегментации, специализирующихся на интерьерах.
       - [ ] Оценка производительности и требований к ресурсам для потенциальных моделей-кандидатов.
       - [ ] Разработка механизма для быстрой смены и тестирования различных моделей.
   - [ ] **1.3. Разработка продвинутых алгоритмов постобработки маски сегментации:**
       - [ ] Реализация алгоритмов для сглаживания краев маски (например, морфологические операции, фильтры).
       - [ ] Разработка методов для заполнения небольших "дыр" и удаления шума в маске.
       - [ ] Исследование методов для улучшения контуров маски, возможно, с использованием информации о градиентах изображения.
   - [ ] **1.4. Оптимизация производительности сегментации:**
       - [ ] Профилирование текущего процесса сегментации для выявления узких мест.
       - [ ] Оптимизация кода обработки данных и выполнения модели.
       - [ ] Исследование возможности квантования модели для ускорения без значительной потери точности.

### 2. Реалистичное Нанесение и Рендеринг Краски
   - [ ] **2.1. Базовое нанесение цвета:**
       - [ ] Обеспечение корректного наложения выбранного цвета на сегментированную область стены.
   - [ ] **2.2. Учет текстуры стены:**
       - [ ] Исследование методов сохранения и наложения оригинальной текстуры стены под виртуальную краску (если возможно).
       - [ ] Либо разработка системы наложения реалистичных текстур краски (матовая, глянцевая и т.д.).
   - [ ] **2.3. Реалистичное освещение и затенение:**
       - [ ] **Анализ освещения сцены:** Разработка методов для оценки существующего освещения в реальной комнате (например, анализ основного направления света, интенсивности).
       - [ ] **Шейдеры для краски:** Создание кастомных шейдеров, которые учитывают:
           - [ ] Диффузное и зеркальное отражение света.
           - [ ] Рассеивание света (subsurface scattering для некоторых типов краски, если необходимо).
           - [ ] Влияние окружающего освещения (ambient light).
       - [ ] **Тени и блики:** Обеспечение корректного отображения теней от объектов на окрашенной стене и бликов на самой краске.
       - [ ] **Цветокоррекция:** Подстройка виртуального цвета краски для соответствия его восприятию в реальном освещении.
   - [ ] **2.4. Взаимодействие с деталями на стене:**
       - [ ] Разработка алгоритмов для аккуратного обхода или исключения из покраски мелких деталей (розетки, выключатели, картины).
       - [ ] Возможно, потребуется интеграция с детекцией объектов.

### 3. Улучшение AR Интеграции и Стабильности
   - [ ] **3.1. Повышение стабильности трекинга:**
       - [ ] Оптимизация использования ARCore/ARKit для более надежного прикрепления виртуального контента к реальным поверхностям.
       - [ ] Исследование методов компенсации дрифта и дрожания.
   - [ ] **3.2. Корректная обработка окклюзий:**
       - [ ] Реализация или улучшение системы окклюзий, чтобы реальные объекты перед стеной (мебель, люди) корректно перекрывали виртуальную краску.
       - [ ] Использование информации о глубине сцены от AR-системы.
   - [ ] **3.3. Адаптация к различным условиям окружения:**
       - [ ] Тестирование и улучшение работы системы при разном освещении, на стенах с разной текстурой и цветом.

### 4. Пользовательский Интерфейс (UI) и Пользовательский Опыт (UX)
   - [ ] **4.1. Разработка интуитивного UI для выбора цвета:**
       - [ ] Реализация цветовых палитр, популярных оттенков.
       - [ ] Возможность выбора цвета пипеткой с реального объекта (если камера позволяет).
       - [ ] Ввод кода цвета (RGB, HEX, или по каталогу производителя красок).
       - [ ] Отображение недавних и избранных цветов.
   - [ ] **4.2. Инструменты взаимодействия:**
       - [ ] "Заливка" стены одним касанием.
       - [ ] Возможность "откатить" изменения (Undo/Redo).
       - [ ] Сохранение различных вариантов покраски.
       - [ ] Режим сравнения "до/после".
   - [ ] **4.3. Визуальная обратная связь:**
       - [ ] Четкое отображение границ сегментации перед покраской (возможно, с опцией предварительного просмотра).
       - [ ] Плавные анимации и переходы.
   - [ ] **4.4. Оптимизация производительности UI:**
       - [ ] Обеспечение быстрой реакции интерфейса на действия пользователя.

### 5. Тестирование и Итерации
   - [ ] **5.1. Регулярное тестирование на целевых устройствах:**
       - [ ] Проверка на различных моделях телефонов с разными характеристиками.
   - [ ] **5.2. Сбор обратной связи от пользователей (если применимо):**
       - [ ] Проведение пользовательских тестов для выявления проблем UX.
   - [ ] **5.3. Итеративная разработка:**
       - [ ] Разбиение крупных задач на более мелкие подзадачи.
       - [ ] Постоянный анализ результатов и корректировка плана.

## Приоритезация (Примерный Порядок):

**Фаза 1: Фундамент (Текущая работа + Ближайшие шаги)**
- [x] (ЗАВЕРШЕНО/В ПРОЦЕССЕ) Базовая сегментация стен и отображение маски.
- [ ] **Приоритет 0: Отладка и исправление генерации процедурных плоскостей (в ARManagerInitializer2.cs):**
    - [x] ~~Убедиться, что генерируемым процедурным плоскостям (например, `MyARPlane_Debug_X`) корректно назначаются компоненты `MeshFilter`, `MeshRenderer` (с видимым материалом) и `MeshCollider`.~~ (Проблема решена, компоненты назначаются, проблема была в другом)
    - [x] ~~Обеспечить, чтобы генерируемые процедурные плоскости создавались на предполагаемом слое (`ARPlanes`), а не `Default`.~~ (Проблема решена, слой назначается корректно)
    - [x] ~~Выяснить происхождение объектов `GeneratedSimulatedPlane(Clone)` со скриптом `SimulatedBoundedPlane` и определить, почему у них отсутствуют необходимые компоненты и корректный слой, если они предназначены для взаимодействия.~~ (Менее релевантно после фокусировки на `ARManagerInitializer2`)
    - [x] (В ПРОЦЕССЕ) Отладка рейкастинга из `ARManagerInitializer2.cs` для корректного определения положения плоскостей:
        - [x] Устранена проблема с пустым `Simulated Environment Scene`.
        - [x] Исправлена ошибка с `minHitDistanceThreshold` в `Mathf.Clamp`.
        - [x] Добавлена и скорректирована отладочная визуализация лучей.
        - [x] Ведется работа над коррекцией направления лучей (`ViewportPointToRay`) относительно сегментированных областей.
        - [x] Устранена проблема с мерцанием плоскостей из-за перекрытия `RawImage` путем настройки `Culling Mask` для `Main Camera` (с модификацией `CameraCullingMaskFixer`).
        - [x] Уменьшена задержка "прилипания" плоскостей (`planeStableTimeThreshold`).
        - [ ] Текущая задача: Проверить, влияет ли отключение `MeshRenderer` создаваемых плоскостей на `RawImage` и корректность сегментации, чтобы окончательно исключить проблему визуального перекрытия на этапе захвата изображения для сегментации.
- [ ] **Приоритет 1:** Достижение стабильной и приемлемо точной сегментации (улучшение текущей модели, базовая постобработка).
- [ ] **Приоритет 2:** Базовое нанесение выбранного сплошного цвета на сегментированную область.
- [ ] **Приоритет 3:** Улучшение стабильности AR-трекинга для окрашенной поверхности.

**Фаза 2: Повышение Реализма и UX**
- [ ] **Приоритет 4:** Разработка базовых шейдеров для более реалистичного отображения цвета (учет основного освещения).
- [ ] **Приоритет 5:** Реализация основного UI для выбора цвета.
- [ ] **Приоритет 6:** Продвинутая постобработка маски (сглаживание, удаление шума).
- [ ] **Приоритет 7:** Базовая обработка окклюзий.

**Фаза 3: Продвинутый Рендеринг и Функционал**
- [ ] **Приоритет 8:** Продвинутые шейдеры (учет текстуры, бликов, более сложного освещения).
- [ ] **Приоритет 9:** Улучшение UI/UX (дополнительные инструменты, сохранение и т.д.).
- [ ] **Приоритет 10:** Исследование и интеграция более совершенных моделей сегментации, если необходимо.
- [ ] **Приоритет 11:** Детальная проработка взаимодействия с мелкими объектами на стенах.

**Фаза 4: Полировка и Оптимизация**
- [ ] Всестороннее тестирование и отладка.
- [ ] Оптимизация производительности на всех уровнях.
- [ ] Финальная настройка визуальных эффектов.

Этот план является гибким и может корректироваться в зависимости от результатов на каждом этапе и возникающих сложностей. 