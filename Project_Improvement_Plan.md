# План Улучшения Проекта Виртуальной Покраски Стен

**Примечание:** Этот план обновлен и дополнен на основе детального экспертного анализа проекта remalux-new-sentis, включая рекомендации по выбору моделей, оптимизации Sentis, интеграции AR Foundation и улучшению пользовательского опыта. **Дополнительно интегрированы результаты анализа скриншотов Unity с конкретными техническими проблемами и их решениями.**

## Цель:
- [ ] Достичь качества визуализации и функциональности, сопоставимых с передовыми приложениями для виртуальной примерки цвета стен (например, Dulux Visualizer).

## Ключевые Направления Работы:

### 1. Улучшение Системы Сегментации Стен
   - [ ] **1.1. Повышение точности и стабильности ML-модели (Текущей или Новой):**
       - [ ] **(КРИТИЧНО - Из анализа скриншотов)** Исправить настройки текущей модели SegFormer:
           - [ ] Повысить порог уверенности с текущего `Wall Confidence ≈0.07` до 0.1-0.2 или выше для отсеивания шума и ложных областей.
           - [ ] Включить отключенную опцию `Apply Mask Smoothing` и подобрать оптимальный радиус размытия (`Mask Blur Size`, например 3–5) для устранения зазубренных краев маски.
           - [ ] Проверить соответствие индексов классов: `Wall Class Index = 1`, `Floor Index = 2` должны соответствовать config.json/id2label выбранной модели SegFormer.
       - [ ] Анализ текущих ошибок сегментации (пропуски, ложные срабатывания).
       - [ ] **(Из экспертного анализа)** Оценка различных вариантов моделей семантической сегментации (например, SegFormer B0, B1, B2, B4, другие легковесные модели) в Sentis на целевых устройствах. Провести бенчмаркинг точности (mIoU) и скорости вывода.
       - [ ] **(Из экспертного анализа)** Убедиться, что выбранная модель дообучена на релевантном датасете (например, ADE20K, содержащем класс "wall").
       - [ ] **(Из экспертного анализа и анализа скриншотов)** Рассмотреть кастомное дообучение на целевом датасете (изображения интерьеров с разными стенами, освещением, окклюзиями) или выбор более специализированной модели, если обобщающая способность текущей SegFormer недостаточна.
       - [ ] **(Из анализа скриншотов)** Рассмотреть увеличение разрешения входного изображения для сегментации (например, до 640x640 или 768x768 px), если производительность позволяет, для получения более четких контуров маски.
   - [ ] **1.2. Исследование и интеграция альтернативных ML-моделей:**
       - [ ] Поиск state-of-the-art моделей для семантической сегментации, специализирующихся на интерьерах.
       - [ ] Оценка производительности и требований к ресурсам для потенциальных моделей-кандидатов.
       - [ ] Разработка механизма для быстрой смены и тестирования различных моделей.
   - [ ] **1.3. Разработка продвинутых алгоритмов предобработки и постобработки:**
       - [ ] **(ПРИОРИТЕТ - Из анализа скриншотов)** Немедленно включить сглаживание маски:
           - [ ] Активировать `Apply Mask Smoothing` в настройках `Wall Segmentation`.
           - [ ] Настроить параметр `Mask Blur Size` (рекомендуется 3-5).
           - [ ] Опции `Enhance Edges` и `Enhance Contrast` уже включены - оценить их эффективность после включения сглаживания.
       - [ ] **(Из экспертного анализа) Эффективная предварительная обработка в Unity:**
           - [ ] Изменение размера входных изображений с камеры до требуемого моделью (например, 512x512 для SegFormer) с использованием `TextureConverter.ToTensor()` или кастомной реализации (оптимизировать!).
           - [ ] Нормализация значений пикселей (среднее и стандартное отклонение, указанные для модели, обычно статистика ImageNet) через `TextureConverter.ToTensor()` или вручную.
           - [ ] Обеспечение правильного порядка каналов (например, RGB) и расположения данных (например, NCHW) для модели.
       - [ ] **(Из экспертного анализа) Постобработка маски сегментации:**
           - [ ] Увеличение разрешения (Upsampling) выходной маски (которая часто имеет меньшее разрешение, например, H/4, W/4 для SegFormer) до исходного разрешения изображения с использованием билинейной интерполяции (операции Sentis или кастомные шейдеры).
           - [ ] Применение морфологических операций (эрозия, дилатация, открытие, закрытие) к бинарной маске стены для удаления шума и заполнения "дыр" (особенно если повышение порога и сглаживание не дадут нужного эффекта).
           - [ ] Анализ связных компонент для отбрасывания меньших, потенциально неверных детекций класса "стена".
   - [ ] **1.4. Оптимизация производительности сегментации:**
       - [ ] Профилирование текущего процесса сегментации для выявления узких мест.
       - [ ] Оптимизация кода обработки данных и выполнения модели.
       - [ ] Исследование возможности квантования модели для ускорения без значительной потери точности.

### 2. Реалистичное Нанесение и Рендеринг Краски
   - [ ] **2.1. Базовое нанесение цвета:**
       - [ ] Обеспечение корректного наложения выбранного цвета на сегментированную область стены (см. также раздел 3.4 по проецированию).
   - [ ] **2.2. Учет текстуры стены:**
       - [ ] **(КРИТИЧНО - Из анализа скриншотов)** Реализовать реалистичное наложение краски вместо сплошного зеленого цвета:
           - [ ] **Вариант 1 (Прозрачное смешивание):** Настроить материал `WallPaint.mat` как полупрозрачный:
               - [ ] Установить `Surface Type = Transparent`
               - [ ] Задать альфа-прозрачность ~0.5
               - [ ] Использовать режим смешивания `Multiply` для перекрашивания оттенка стены с сохранением теней и бликов
               - [ ] Проверить и настроить параметр `BlendFactor` (сейчас 0.5)
           - [ ] **Вариант 2 (Шейдер с маской):** Довести до рабочей стадии существующий шейдер `WallPaint.mat`:
               - [ ] Убедиться, что текстура `_SegmentationMask` передается в материал и обновляется каждый кадр
               - [ ] Шейдер должен окрашивать только области маски "стена" (не затрагивая окна, картины и т.п.)
               - [ ] Рассмотреть включение опции `USE_YIQ` (сейчас отключена) для сохранения яркости при изменении оттенка
               - [ ] Реализовать небольшое расширение маски (дилатация) для предотвращения "ореолов"
   - [ ] **2.3. Реалистичное освещение и затенение:**
       - [ ] **Анализ освещения сцены:** 
           - [ ] **(Из анализа скриншотов)** Активировать скрипт `ARLightEstimation` (если есть в проекте) для подстройки `Directional Light` под реальное освещение.
           - [ ] Разработка методов для оценки существующего освещения в реальной комнате (например, анализ основного направления света, интенсивности).
       - [ ] **Шейдеры для краски:** Создание кастомных шейдеров, которые учитывают:
           - [ ] Диффузное и зеркальное отражение света.
           - [ ] Рассеивание света (subsurface scattering для некоторых типов краски, если необходимо).
           - [ ] Влияние окружающего освещения (ambient light).
           - [ ] **(Из экспертного анализа)** Исследовать использование `AREnvironmentProbeManager` для получения данных об освещении окружения и их применения к виртуальным материалам для более реалистичного вида.
       - [ ] **Тени и блики:** Обеспечение корректного отображения теней от объектов на окрашенной стене и бликов на самой краске.
       - [ ] **Цветокоррекция:** Подстройка виртуального цвета краски для соответствия его восприятию в реальном освещении.
       - [ ] **(ПРИОРИТЕТ - Из анализа скриншотов) Настройки рендера для AR-плоскостей:**
           - [ ] Отключить `Cast Shadows = Off` у материала или `MeshRenderer` плоскостей `MyARPlane_Debug` (тени от виртуальной плоскости не нужны).
           - [ ] Снять флаг `Static` с AR-плоскостей (они динамичны).
           - [ ] Исключить AR-плоскости из расчета глобального освещения (GI).
   - [ ] **2.4. Взаимодействие с деталями на стене:**
       - [ ] Разработка алгоритмов для аккуратного обхода или исключения из покраски мелких деталей (розетки, выключатели, картины).
       - [ ] Возможно, потребуется интеграция с детекцией объектов.

### 3. Улучшение AR Интеграции и Стабильности
   - [ ] **3.1. Повышение стабильности трекинга и управления AR-плоскостями:**
       - [ ] **(КРИТИЧНО - Из анализа скриншотов) Устранение дублирования AR-плоскостей:**
           - [ ] Исправить логику удаления перекрывающихся плоскостей в `ARManagerInitializer2.cs`:
               - [ ] Увеличить порог расстояния между плоскостями с 0.2м до 0.3-0.5м
               - [ ] Добавить проверку совпадения нормалей для отсеивания дублей на одной стене
               - [ ] Проверить работу механизма `Persistent Planes` - сохраненные плоскости не должны размножаться
               - [ ] Рассмотреть сброс счетчика `planeInstanceCounter` при новом сеансе
       - [ ] **(Из анализа скриншотов) Рассмотреть комбинированный подход AR+сегментация:**
           - [ ] Сейчас флаг `Use Detected Planes` в `ARManagerInitializer2` отключен - система полагается только на сегментацию
           - [ ] Исследовать включение `ARPlaneManager` для вертикальных плоскостей + использование сегментации как фильтра
           - [ ] Если оставить чисто сегментационный подход - повысить устойчивость через инерцию/задержку создания/удаления плоскостей
           - [ ] Проверить корректность применения параметра `Failure Threshold = 10` в `Wall Segmentation`
       - [ ] **(Из анализа скриншотов) Проверка позиционирования и слоев:**
           - [ ] Убедиться, что `Main Camera` имеет компонент `AR Camera Background` для видеопотока на устройстве
           - [ ] Проверить `Culling Mask` основной камеры (должен включать слой `ARPlanes` и UI)
           - [ ] На время AR-сессии отключать рендер и коллайдеры у объектов `Simulated Environment` или ограничить `Hit Layer Mask` рейкастов
   - [ ] **3.2. Корректная обработка окклюзий:**
       - [ ] **(Из анализа скриншотов)** Для реалистичного эффекта (перекрытие виртуальной краски реальными объектами) добавить `AROcclusionManager`:
           - [ ] Включить `Human Depth Occlusion` или `Human Segmentation Stencil`
           - [ ] Настроить `EnvironmentDepthMode` (Medium/Best для качества, Fastest для производительности)

### 4. Пользовательский Интерфейс (UI) и Пользовательский Опыт (UX)
   - [ ] **4.1. Разработка интуитивного UI для выбора цвета:**
       - [ ] **(Из анализа скриншотов)** Проверить инициализацию UI выбора цвета:
           - [ ] Объекты `ColorPickerUICreator`, префабы `CanvasPrefab`/`PanelPrefab`/`ColorButtonPrefab` должны корректно инициализироваться
           - [ ] `Canvas` настроить в режиме `Screen Space – Overlay` или `Screen Space – Camera` с AR-камерой
           - [ ] `EventSystem` уже присутствует - это хорошо
       - [ ] Реализация цветовых палитр, популярных оттенков.
       - [ ] Возможность выбора цвета пипеткой с реального объекта (если камера позволяет и производительность не страдает).
       - [ ] Ввод кода цвета (RGB, HEX, или по каталогу производителя красок).
       - [ ] Отображение недавних и избранных цветов.
   - [ ] **4.2. Инструменты взаимодействия:**
       - [ ] "Заливка" стены одним касанием.
       - [ ] Возможность "откатить" изменения (Undo/Redo).
       - [ ] Сохранение различных вариантов покраски.
       - [ ] Режим сравнения "до/после".
   - [ ] **4.3. Визуальная обратная связь:**
       - [ ] **(КРИТИЧНО - Из анализа скриншотов) Исправить блокировку UI:**
           - [ ] Отключить `Raycast Target` у отладочного `RawImage` (сейчас блокирует касания по экрану)
           - [ ] Альтернативно: переместить `RawImage` в угол экрана, уменьшить размер, сделать полупрозрачным
           - [ ] В финальной версии скрыть отладочный UI полностью
       - [ ] **(Из анализа скриншотов)** Улучшить обратную связь пользователю:
           - [ ] При выборе цвета сразу давать визуальную обратную связь (окрашивание иконки/подсветка стены)
           - [ ] Если стена выбирается автоматически, показывать какая стена активна ("Стена обнаружена – готова к покраске")
           - [ ] Определиться с механикой: тап по AR-плоскости для выбора стены vs автоматический выбор
       - [ ] Четкое отображение границ сегментации перед покраской (возможно, с опцией предварительного просмотра).
       - [ ] Плавные анимации и переходы.
   - [ ] **4.4. Оптимизация производительности UI:**
       - [ ] Обеспечение быстрой реакции интерфейса на действия пользователя.
   - [ ] **4.5. (Новый подраздел) Чистота сцены и переключение режимов:**
       - [ ] **(Из анализа скриншотов)** Обеспечить правильное переключение между симуляцией и устройством:
           - [ ] `SimulationCamera` и `Simulated Environment Scene` должны использоваться только в редакторе
           - [ ] Проверить флаг `Use Simulation If...` в `Wall Segmentation`
           - [ ] Автоматизировать выгрузку сцены симуляции при запуске на устройстве
           - [ ] Проверить `AR_WallPainting` в `DontDestroyOnLoad` на утечки событий при повторном запуске

### 5. Тестирование и Итерации
   - [ ] **5.1. Регулярное тестирование на целевых устройствах:**
       - [ ] Проверка на различных моделях телефонов с разными характеристиками.
   - [ ] **5.2. Сбор обратной связи от пользователей (если применимо):**
       - [ ] Проведение пользовательских тестов для выявления проблем UX.
   - [ ] **5.3. Итеративная разработка:**
       - [ ] Разбиение крупных задач на более мелкие подзадачи.
       - [ ] Постоянный анализ результатов и корректировка плана.

## Приоритезация (Примерный Порядок):

**Примечание по Приоритезации:** Список обновлен с учетом критичных проблем, выявленных при анализе скриншотов Unity.

**Фаза 1: Критические исправления (На основе анализа скриншотов)**
- [x] (ЗАВЕРШЕНО/В ПРОЦЕССЕ) Базовая сегментация стен и отображение маски.
- [x] **Приоритет 0A (КРИТИЧНО - ВЫПОЛНЕНО):** Исправление настроек сегментации:
    - [x] Повышен `Wall Confidence` с 0.07 до 0.15 для устранения шума
    - [x] Повышен `segmentationConfidenceThreshold` с 0.01 до 0.15 для лучшего качества
    - [x] Проверены настройки `Apply Mask Smoothing = true` и `Mask Blur Size = 4`
    - [x] Проверено соответствие индексов классов модели (Wall Class Index = 1, Floor Index = 2)
- [x] **Приоритет 0B (КРИТИЧНО - ВЫПОЛНЕНО):** Устранение дублирования AR-плоскостей:
    - [x] Исправлена логика удаления перекрывающихся `MyARPlane_Debug_X` объектов
    - [x] Увеличен порог расстояния для экстремально близких плоскостей с 0.2м до 0.4м
    - [x] Добавлена проверка совпадения нормалей (порог 20°) и расстояний (0.35м) для отсеивания дублей
    - [x] Улучшена логика сравнения времени создания плоскостей
- [x] **Приоритет 0C (КРИТИЧНО - ВЫПОЛНЕНО):** Исправление блокирующего UI:
    - [x] Отключен `Raycast Target` у отладочного `RawImage` в `DebugMaskLinker.cs`
    - [x] Добавлено отключение `Raycast Target` в методе `УстановитьОтображениеМаскиUI` в `ARManagerInitializer2.cs`
    - [x] Создан `CriticalFixesValidator.cs` для автоматической проверки исправлений
- [x] **Приоритет 0D (ТЕХНИЧЕСКИЕ ИСПРАВЛЕНИЯ - ВЫПОЛНЕНО):** Устранение ошибок компиляции:
    - [x] Исправлены синтаксические ошибки в `CriticalFixesValidator.cs`
    - [x] Добавлены недостающие using директивы (`System.Reflection`)
    - [x] Устранен конфликт с зарезервированным ключевым словом `fixed` → `fixedCount`
    - [x] Проект готов к компиляции без ошибок

**Фаза 1 (продолжение): Фундамент**
- [x] **Приоритет 1 (ВЫПОЛНЕНО):** Достижение стабильной сегментации:
    - [x] Реализована система адаптивного разрешения (384px-768px)
    - [x] Добавлен мониторинг производительности в реальном времени
    - [x] Система автоматически корректирует разрешение на основе времени обработки
    - [x] Интегрирована оценка качества маски для принятия решений
    - [x] Добавлены публичные API для управления разрешением
    - [x] Расширена система валидации для контроля производительности
- [x] **Приоритет 2 (ВЫПОЛНЕНО):** Реалистичное нанесение краски:
    - [x] Реализовано прозрачное смешивание с _BlendFactor вместо сплошного зеленого цвета
    - [x] Интегрирована маска сегментации в материалы для точного наложения краски
    - [x] Создана система ARWallPaintColorManager для управления цветами
    - [x] Добавлены 8 предустановленных цветов и слайдер прозрачности
    - [x] Реализовано динамическое применение изменений ко всем плоскостям
    - [x] Система валидации и тестирования через Context Menu
- [ ] **Приоритет 3:** Стабильность AR (комбинированный подход или улучшенная инерция, настройки камеры и слоев).

**Фаза 2: Повышение Реализма и UX**
- [ ] **Приоритет 4:** Освещение и материалы (ARLightEstimation, правильные настройки теней для плоскостей).
- [ ] **Приоритет 5:** Полнофункциональный UI для выбора цвета с правильной инициализацией.
- [ ] **Приоритет 6:** Продвинутая постобработка маски (морфологические операции при необходимости).
- [ ] **Приоритет 7:** Базовая окклюзия через AROcclusionManager.

**Фаза 3: Продвинутый Рендеринг и Функционал**
- [ ] **Приоритет 8:** Продвинутые шейдеры (USE_YIQ, зонды окружения, детальное смешивание).
- [ ] **Приоритет 9:** Расширенный UI/UX (механика покраски, подсказки, сохранение).
- [ ] **Приоритет 10:** Дообучение/замена моделей сегментации при необходимости.
- [ ] **Приоритет 11:** Взаимодействие с объектами на стенах через маску.

**Фаза 4: Полировка и Оптимизация**
- [ ] Всестороннее тестирование и отладка (см. раздел 5).
- [ ] Оптимизация производительности на всех уровнях (см. раздел 1.4 и 6.1).
- [ ] Финальная настройка визуальных эффектов.

## Текущий Статус Реализации
**Все критические исправления (Приоритеты 0A-0D) ЗАВЕРШЕНЫ! ✅**
- Система сегментации настроена с правильными порогами уверенности
- Дублирование AR-плоскостей устранено
- UI взаимодействие восстановлено
- Ошибки компиляции исправлены
- Система валидации активна и мониторит состояние исправлений

**🎉 КРИТИЧЕСКАЯ ПРОБЛЕМА РЕШЕНА - Рейкастинг и создание AR плоскостей! ✅**
- ✅ **SceneSetupHelper** автоматически создает симулированную среду при запуске
- ✅ **Рейкасты попадают в геометрию** - больше нет "ПРОМАХ" в логах
- ✅ **AR плоскости создаются корректно** - видны зеленые плоскости на стенах
- ✅ **Сегментация работает стабильно** - разноцветная маска обновляется в реальном времени
- ✅ **Все системы интегрированы** - ARManagerInitializer2, WallSegmentation, SceneSetupHelper работают синхронно

**🎨 ЗАВЕРШЕН: Приоритет 2 - Реалистичное нанесение краски! ✅**
- ✅ **Реалистичные материалы:** Прозрачное смешивание с _BlendFactor=0.7 вместо сплошного зеленого
- ✅ **Интеграция с маской:** Материалы используют _SegmentationMask для точного наложения краски
- ✅ **ARWallPaintColorManager:** Система управления цветами с 8 предустановленными вариантами
- ✅ **Динамическое изменение:** Цвет и прозрачность применяются в реальном времени ко всем плоскостям
- ✅ **Система валидации:** ValidateRealisticPaintSystem, тестирование цветов и прозрачности
- ✅ **Context Menu API:** Быстрое тестирование и отладка через Unity Inspector

**ГОТОВ К ПЕРЕХОДУ: Приоритет 3 - Стабильность AR 🔧**

**Следующие шаги:**
1. **Улучшить стабильность AR трекинга** и настройки камеры
2. **Добавить окклюзию** для реалистичного перекрытия виртуальной краски реальными объектами  
3. **Оптимизировать слои и рендеринг** для лучшей производительности

Этот план является гибким и может корректироваться в зависимости от результатов на каждом этапе и возникающих сложностей.

## 4. Дополнительные улучшения

* **Альтернативные модели сегментации (DeepLab v3+).** Рассмотреть более точные SOTA-модели для семантической сегментации интерьеров и протестировать их производительность на целевых устройствах ([arXiv][7]).
* **Дополнительная аугментация данных.** Собрать больше снимков со сложным освещением и текстурами для дообучения модели на реальных кейсах ([GitHub][2]).
* **Реалистичные шейдеры краски.** Добавить расчёт нормалей и бликов (specular) в кастомных шейдерах, чтобы виртуальная краска реагировала на освещение так же, как реальная ([GitHub][2]).

Такой план доработок устранит основные артефакты из видео и сделает виртуальную покраску стен более реалистичной и стабильной.

[1]: https://www.youtube.com/shorts/EvMZT5WEzSM "Failed"
[2]: https://github.com/alidarovolj/remalux-new-sentis "GitHub - alidarovolj/remalux-new-sentis"
[3]: https://docs.opencv.org/3.4/db/df6/tutorial_erosion_dilatation.html?utm_source=chatgpt.com "Eroding and Dilating - OpenCV Documentation"
[4]: https://medium.com/%40lemapp09/beginning-game-development-arkit-arcore-depth-apis-cfe9e3c4c71f?utm_source=chatgpt.com "Beginning Game Development: ARKit/ARCore Depth APIs - Medium"
[5]: https://encord.com/blog/image-thresholding-image-processing/?utm_source=chatgpt.com "Image Thresholding in Image Processing | Encord"
[6]: https://opencv-tutorial.readthedocs.io/en/latest/?utm_source=chatgpt.com "Welcome to the OpenCV tutorial — OpenCV tutorial ... - Read the Docs"
[7]: https://arxiv.org/abs/1802.02611?utm_source=chatgpt.com "Encoder-Decoder with Atrous Separable Convolution for Semantic Image Segmentation"

## 5. План улучшений на основе анализа логов Xcode (из `ARManagerInitializer2.cs`)

Детальный анализ логов работы метода `UpdateOrCreatePlaneForWallArea` выявил следующие потенциальные области для улучшения стабильности и точности генерации AR-плоскостей:

### 5.1. Оптимизация Рейкастинга
-   **[ ] Проанализировать и оптимизировать `maxRayDistance`**: Убедиться, что максимальная дистанция рейкаста в `UpdateOrCreatePlaneForWallArea` (в коде используется значение из поля класса, но также есть локальная переменная) адекватна для целевых окружений и все релевантные поверхности могут быть достигнуты.
-   **[ ] Настроить `hitLayerMask`**: Текущее значение `-1` ("Everything") может быть неоптимальным. Рассмотреть сужение маски до слоев, содержащих релевантную геометрию (например, `SimulatedEnvironment`, `Wall`, `Default`), для повышения производительности и уменьшения ложных срабатываний.
-   **[ ] Улучшить обработку промахов рейкаста**: Если большинство лучей (особенно центральные) регулярно промахиваются, это снижает точность. Рассмотреть:
    -   Более адаптивную эвристику при отсутствии попаданий.
    -   Временное незначительное расширение паттерна лучей или увеличение их количества при первичных промахах.
-   **[ ] Пересмотреть паттерн и веса лучей**: Оценить текущий паттерн из 13 лучей и их веса. Возможно, для некоторых сценариев потребуется другая конфигурация для более надежного определения поверхности.

### 5.2. Корректировка Логики Персистентных Плоскостей
-   **[ ] Тонкая настройка порогов `OverlapsWithPersistentPlanes`**: Параметры `maxOverlapDistance` (сейчас 0.5f) и `maxAngleDifference` (сейчас 25f) могут быть слишком строгими или, наоборот, недостаточно строгими, что приводит либо к пропуску создания нужных новых плоскостей, либо к созданию дубликатов рядом с персистентными. Требуется подбор оптимальных значений.

### 5.3. Улучшение Фильтрации Мелких и Нестабильных Плоскостей
-   **[ ] Оптимизировать параметры фильтрации областей маски**: Подобрать значения для `minAreaSizeInPixels` и `minPixelsDimensionForArea`, чтобы более эффективно отсеивать шум от маски сегментации до этапа рейкастинга.
-   **[ ] Проанализировать `minPlaneSizeInMeters`**: Убедиться, что текущее значение (0.1м) оптимально. Если оно слишком велико, мелкие, но важные участки стен могут игнорироваться. Если слишком мало — может генерироваться много ненужных мелких плоскостей.
-   **[ ] Настроить `unvisitedPlaneRemovalDelay`**: Время (0.5с), через которое "непосещенная" плоскость удаляется, может быть слишком коротким, приводя к исчезновению стабильных плоскостей при кратковременных сбоях сегментации или трекинга. Рассмотреть увеличение до 1.0-1.5с.

### 5.4. Оптимизация Кластеризации Результатов Рейкастинга
-   **[ ] Изменить порог активации кластеризации**: Текущий порог `successfulHits.Count > 3` может быть высоким, если рейкастинг часто дает мало валидных попаданий. Рассмотреть снижение до `> 1` или `> 2` для более частого использования усреднения.

### 5.5. Настройка Параметров Обнаружения Стен
-   **[ ] Проверить `maxWallNormalAngleDeviation`**: Значение `20.0°` может быть слишком строгим для некоторых реальных поверхностей. Проанализировать, не отфильтровываются ли из-за этого корректные стены. 