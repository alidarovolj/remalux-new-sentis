# Система покраски стен в AR (Remalux AR Wall Painter)

Эта система позволяет реализовать функциональность окрашивания стен в дополненной реальности, аналогичную приложению Dulux Visualizer. Основное отличие от предыдущей версии заключается в том, что покраска теперь применяется непосредственно к AR-плоскостям (стенам), а не как эффект обработки изображения с камеры.

## Особенности

- **Привязка цвета к AR-плоскостям**: Цвет применяется непосредственно к 3D-объектам стен в AR-пространстве
- **Реалистичное освещение**: Учитывается освещение помещения для более реалистичного отображения цвета
- **Маскирование стен**: Используется как сегментация на основе AI, так и геометрическое определение вертикальных плоскостей
- **Взаимодействие через тап**: Пользователь может выбирать конкретные стены для покраски
- **Настраиваемая интенсивность**: Регулируемая прозрачность эффекта покраски

## Состав системы

Система состоит из следующих компонентов:

1. **WallPaintEffect** - основной эффект покраски, теперь с поддержкой привязки к AR-плоскостям
2. **ARWallPainter** - обработчик взаимодействия пользователя для выбора стен и управления покраской
3. **WallMaskGenerator** - создает маску стен на основе обнаруженных AR-плоскостей
4. **WallSegmentation** - ML компонент для сегментации стен (улучшает точность определения)
5. **ARWallPainterSystem** - компонент-компоновщик для быстрой настройки всей системы

## Быстрый старт

### Вариант 1: Использование компонента ARWallPainterSystem

1. Создайте пустой GameObject в вашей AR-сцене
2. Добавьте компонент `ARWallPainterSystem`
3. При запуске система автоматически найдет или создаст все необходимые компоненты

### Вариант 2: Ручная настройка

1. Добавьте компонент `WallPaintEffect` на объект камеры AR
2. Добавьте компонент `ARWallPainter` на тот же объект
3. Добавьте объект с компонентом `WallSegmentation` для ML-сегментации (опционально)
4. Добавьте объект с компонентом `WallMaskGenerator` для уточнения масок стен (опционально)
5. Настройте ссылки между компонентами:
   - В `ARWallPainter` укажите ссылку на `WallPaintEffect` и `ARRaycastManager`
   - В `WallPaintEffect` включите опцию "Attach To AR Planes"
   - В `WallMaskGenerator` укажите материал из `WallPaintEffect`

## Требования к AR-сцене

Для правильной работы системы в сцене должны присутствовать:

- ARSessionOrigin (или XR Origin)
- ARSession
- ARPlaneManager (с настроенным Plane Prefab)
- ARRaycastManager

## Интеграция с UI

Вы можете взаимодействовать с системой через публичные методы `ARWallPainterSystem`:

```csharp
// Найти систему покраски
ARWallPainterSystem wallPainter = FindObjectOfType<ARWallPainterSystem>();

// Изменить цвет
wallPainter.SetWallColor(new Color(1, 0, 0)); // Красный

// Изменить интенсивность покраски
wallPainter.SetPaintIntensity(0.7f); // 70% непрозрачности

// Сбросить все покрашенные стены
wallPainter.ResetWalls();

// Включить/выключить использование маски сегментации
wallPainter.SetUseMask(true);
```

## Настройка шейдера WallPaint

Шейдер `WallPaint` был улучшен для лучшей работы с AR-плоскостями:

- Добавлена обработка нормалей для определения вертикальных поверхностей
- Добавлена поддержка текстуры маски стен (`_WallMaskTexture`)
- Улучшено освещение с учетом AR-освещения
- Добавлены дополнительные параметры настройки в инспекторе

## Особенности использования

1. **Качество обнаружения плоскостей**: Для лучших результатов рекомендуется сканировать помещение, медленно перемещая камеру
2. **Вертикальные плоскости**: Настройте ARPlaneManager для обнаружения вертикальных плоскостей (стен)
3. **Настройка интенсивности**: Начните с низкой интенсивности (~0.3) для более реалистичного эффекта
4. **Освещение**: Для наилучших результатов используйте вместе с компонентом `ARLightEstimation`

## Решение проблем

1. **Цвет не применяется к стенам**:
   - Убедитесь, что ARPlaneManager обнаруживает вертикальные плоскости
   - Проверьте, что на плоскостях есть компонент MeshRenderer

2. **Неправильные цвета**:
   - Проверьте настройки ARLightEstimation
   - В материале шейдера настройте параметры "Color Correction" и "Ambient Brightness"

3. **Производительность**:
   - Уменьшите размер текстуры маски стен в WallMaskGenerator (textureWidth/textureHeight)
   - Увеличьте интервал обновления маски (updateInterval)

## Расширенная настройка

### Изменение способа определения стен

По умолчанию система использует комбинацию методов для определения стен:

1. Вертикальные AR-плоскости (геометрический метод)
2. ML-сегментация с использованием Sentis (если доступно)
3. Дополнительная текстура маски стен (для улучшения точности)

Вы можете выбрать предпочтительный метод:

```csharp
// Только сегментация на основе AI
wallPainter.SetUseMask(true);
wallPaintEffect.SetAttachToARPlanes(false);

// Только AR-плоскости без AI
wallPainter.SetUseMask(false);
wallPaintEffect.SetAttachToARPlanes(true);

// Комбинированный метод (рекомендуется)
wallPainter.SetUseMask(true);
wallPaintEffect.SetAttachToARPlanes(true);
```

## Примечания

- В iOS система может требовать дополнительного времени для инициализации
- Приоритетно использовать для iOS 16.0+ с поддержкой ARKit 6.0 и выше
- Для Android требуется поддержка ARCore 