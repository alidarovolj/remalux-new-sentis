# Инструкция по настройке AR-сцены

## Проблема

Основная проблема, которая наблюдалась в приложении - плоскости и сегментированные области "прилипали" к камере вместо того, чтобы оставаться в AR-пространстве. Это происходило из-за неверной структуры AR-компонентов и отсутствия правильного использования якорей.

## Решение

Были созданы следующие инструменты для решения проблемы:

1. **ARSceneSetup.cs** - редактор для автоматического создания правильной AR-сцены
2. **ARWallPaintController.cs** - оптимизированный контроллер для управления покраской стен
3. **OptimizedWallPaint.shader** - шейдер для корректной работы с мировыми координатами

## Особенности обновленной версии

В новой версии инструментов используются актуальные рекомендации Unity:
- Замена устаревшего `ARSessionOrigin` на современный `XROrigin`
- Использование `requestedDetectionMode` вместо устаревшего `detectionMode`
- Добавление объекта `Camera Offset` для правильного расположения камеры
- Корректный вызов метода `AttachAnchor` с актуальными параметрами

## Как использовать

### Для создания новой сцены

1. Откройте Unity Editor
2. Перейдите в меню "AR Tools" -> "Настроить AR Сцену"
3. Будет автоматически создана структура с правильной иерархией:
   - AR Session
   - XR Origin
     - Camera Offset
       - AR Camera (с необходимыми компонентами)
4. Префаб для визуализации плоскостей будет создан автоматически в папке Assets/Prefabs

### Для исправления существующей сцены

1. Откройте вашу существующую сцену
2. Перейдите в меню "AR Tools" -> "Исправить существующую AR сцену"
3. Скрипт автоматически:
   - Конвертирует устаревший ARSessionOrigin в XROrigin, если он присутствует
   - Добавит Camera Offset объект и правильно настроит иерархию
   - Добавит недостающие компоненты

### Создание материала для покраски

1. Перейдите в меню "AR Tools" -> "Создать материал для покраски стен"
2. Будет создан материал на основе шейдера OptimizedWallPaint

### Настройка ARWallPaintController

1. Добавьте компонент ARWallPaintController к объекту XROrigin в иерархии
2. Настройте следующие параметры:
   - **AR компоненты**: должны автоматически быть определены
   - **Настройки обнаружения**: установите preferVerticalPlanes = true для обнаружения только стен
   - **Покраска**: назначьте материал OptimizedWallPaint, созданный на предыдущем шаге
   - **Отладка**: при необходимости включите debugMode для визуализации сетки и дополнительной информации

### Тестирование

1. Запустите приложение на устройстве
2. Убедитесь, что обнаруживаются плоскости (они должны оставаться на месте при движении камеры)
3. Если плоскости не обнаруживаются:
   - Проверьте освещение и текстурированность поверхностей
   - Убедитесь, что на устройстве поддерживается ARCore/ARKit
   - Проверьте логи на наличие ошибок AR-сессии

## Принцип работы

Новая структура обеспечивает:

1. **Правильную иерархию AR-компонентов**: XROrigin содержит все необходимые менеджеры и камеру с правильной структурой вложенности
2. **Использование якорей**: для каждой обнаруженной плоскости создается ARAnchor с корректной позой (Pose), к которому привязывается информация о покраске
3. **Работу шейдера в мировых координатах**: передача правильных матриц трансформации в шейдер
4. **Оптимизированную обработку событий**: эффективная обработка добавления, обновления и удаления плоскостей
5. **Сохранение данных**: поддержка сохранения данных о покраске между сессиями (если опция включена)

## Важные моменты

- AR-камера должна быть дочерним объектом Camera Offset, который находится под XROrigin
- Все AR-менеджеры (ARPlaneManager, ARAnchorManager, ARRaycastManager) должны быть на объекте XROrigin
- Якоря (ARAnchor) создаются для каждой обнаруженной плоскости через ARAnchorManager
- Материалы с шейдером должны получать актуальные матрицы трансформации камеры
- Для визуализации AR-плоскостей используется prefab с ARPlaneMeshVisualizer 